{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ subject_name|title }} - Book</title>
<style>
body { margin:0; font-family: sans-serif; background: #f8f9fa; display:flex; height:100vh; overflow:hidden; }
.toolbar { position: fixed; top:0; width:100%; background:#fff; border-bottom:1px solid #ddd; padding:8px 16px; display:flex; justify-content: space-between; z-index:10; }
.tool-btn { background:#007aff; color:white; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; }
.tool-btn:hover { background:#005bb5; }
.pdf-container { flex:1; overflow-y: scroll; padding:70px 20px 20px 20px; }
canvas { display:block; margin:0 auto 20px auto; border-radius:8px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.sidebar { position: fixed; right:-400px; top:0; height:100%; width:400px; background:#fff; box-shadow:-2px 0 6px rgba(0,0,0,0.1); transition: right 0.3s; display:flex; flex-direction:column; z-index:20; }
.sidebar.open { right:0; }
.sidebar-header { padding:15px; background:#007aff; color:white; font-weight:600; display:flex; justify-content:space-between; align-items:center; }
.sidebar-content { flex:1; display:flex; flex-direction:column; padding:10px; }
#chat-window { flex:1; overflow-y:auto; padding:10px; border:1px solid #eee; border-radius:6px; background:#fafafa; font-size:14px; }
#chat-window div { margin-bottom:10px; line-height:1.4em; }
.loading { font-style:italic; color:#888; }
#chat-input { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; }
.chat-controls { display:flex; gap:6px; margin-top:8px; }
.quiz-btn { margin-top:10px; background:#28a745; }
</style>
</head>
<body>

<div class="toolbar">
  <div><strong>{{ subject_name|title }}</strong></div>
  <div><button class="tool-btn" id="toggle-sidebar">ðŸ’¬ Chat with AI</button></div>
</div>

<div class="pdf-container"><div id="pdf-viewer"></div></div>

<div class="sidebar" id="chat-sidebar">
  <div class="sidebar-header">
    Chat with Gemini
    <button class="tool-btn" id="close-sidebar" style="background:#ff3b30;">Ã—</button>
  </div>
  <div class="sidebar-content">
    <div id="chat-window"></div>
    <div class="chat-controls">
      <input id="chat-input" placeholder="Ask about this book..." />
      <button id="send-btn" class="tool-btn">Send</button>
    </div>
    <form id="quiz-form" action="{% url 'generate_quiz_from_ai' %}" method="get" target="_blank" style="margin-top:10px; display:none;">
      <input type="hidden" name="content" id="quiz-content" value="">
      <button type="submit" class="tool-btn quiz-btn">Generate Quiz from AI Reply</button>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
const pdfPath = "{% static 'books/'|add:subject_name|add:'.pdf' %}";
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
async function renderPDF(){
  const pdf = await pdfjsLib.getDocument(pdfPath).promise;
  const container = document.getElementById('pdf-viewer');
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({scale:1.5});
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    container.appendChild(canvas);
    await page.render({canvasContext:context,viewport}).promise;
  }
}
renderPDF();

const sidebar = document.getElementById('chat-sidebar');
document.getElementById('toggle-sidebar').onclick = ()=>sidebar.classList.add('open');
document.getElementById('close-sidebar').onclick = ()=>sidebar.classList.remove('open');

const chatWindow = document.getElementById('chat-window');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const quizForm = document.getElementById('quiz-form');
const quizContentInput = document.getElementById('quiz-content');

function getCSRFToken(){
  const name='csrftoken';
  const cookies=document.cookie.split(';');
  for(let c of cookies){c=c.trim(); if(c.startsWith(name+'=')) return decodeURIComponent(c.substring(name.length+1));}
  return '';
}

sendBtn.addEventListener('click', sendQuestion);
chatInput.addEventListener('keypress', e=>{if(e.key==='Enter') sendQuestion();});

async function sendQuestion(){
  const question = chatInput.value.trim();
  if(!question) return;
  chatWindow.innerHTML+=`<div><b>You:</b> ${question}</div>`;
  chatInput.value="";
  chatWindow.innerHTML+=`<div class="loading">Thinking...</div>`;
  chatWindow.scrollTop = chatWindow.scrollHeight;

  const res = await fetch(`/subject12/{{ subject_name }}/ask/`,{
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},
    body: JSON.stringify({question})
  });
  const data = await res.json();
  document.querySelector('.loading').remove();

  if(data.error){
    chatWindow.innerHTML+=`<div style="color:red"><b>Error:</b> ${data.error}</div>`;
  } else {
    chatWindow.innerHTML+=`<div><b>AI:</b> ${data.answer}</div>`;
    // Enable quiz button
    quizContentInput.value = data.answer;
    quizForm.style.display = 'block';
  }
  chatWindow.scrollTop = chatWindow.scrollHeight;
}
</script>
</body>
</html>
